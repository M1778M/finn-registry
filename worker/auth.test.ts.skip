import { describe, it, expect, beforeEach, vi } from 'vitest'
import app from './index'

// Mock D1Database
const createMockD1 = () => {
  const db = {
    prepare: vi.fn(),
  }

  return db
}

// Mock environment bindings
const mockEnv = {
  finn_db: createMockD1(),
  GITHUB_CLIENT_ID: 'test-client-id',
  GITHUB_CLIENT_SECRET: 'test-client-secret',
  APP_URL: 'http://localhost:3000',
}

describe('Auth Endpoints', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('GET /api/health', () => {
    it('should return health status', async () => {
      const req = new Request('http://localhost/api/health')
      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(200)
      expect(json).toHaveProperty('status', 'ok')
      expect(json).toHaveProperty('timestamp')
    })
  })

  describe('POST /api/auth/logout', () => {
    it('should handle logout with valid session', async () => {
      const req = new Request('http://localhost/api/auth/logout', {
        method: 'POST',
        headers: {
          'Cookie': 'finn_session=test_session_id',
        },
      })

      const db = mockEnv.finn_db
      ;(db.prepare as any).mockReturnValue({
        bind: vi.fn().mockReturnValue({
          run: vi.fn().mockResolvedValue({ success: true }),
        }),
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(200)
      expect(json).toEqual({ success: true })
    })

    it('should handle logout without session', async () => {
      const req = new Request('http://localhost/api/auth/logout', {
        method: 'POST',
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(200)
      expect(json).toEqual({ success: true })
    })
  })

  describe('POST /api/cli/auth', () => {
    it('should authenticate with valid API token', async () => {
      const req = new Request('http://localhost/api/cli/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          api_token: 'finn_tok_valid_token',
        }),
      })

      const db = mockEnv.finn_db
      ;(db.prepare as any).mockReturnValue({
        bind: vi.fn().mockReturnValue({
          first: vi.fn().mockResolvedValue({
            id: 1,
            username: 'testuser',
            avatar_url: 'https://example.com/avatar.jpg',
          }),
        }),
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(200)
      expect(json).toEqual({
        authenticated: true,
        user: {
          id: 1,
          username: 'testuser',
          avatar_url: 'https://example.com/avatar.jpg',
        },
      })
    })

    it('should reject invalid API token', async () => {
      const req = new Request('http://localhost/api/cli/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          api_token: 'finn_tok_invalid_token',
        }),
      })

      const db = mockEnv.finn_db
      ;(db.prepare as any).mockReturnValue({
        bind: vi.fn().mockReturnValue({
          first: vi.fn().mockResolvedValue(null),
        }),
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(401)
      expect(json).toEqual({ error: 'Invalid API token' })
    })

    it('should return 400 when api_token is missing', async () => {
      const req = new Request('http://localhost/api/cli/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({}),
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(400)
      expect(json).toEqual({ error: 'Missing api_token' })
    })
  })

  describe('GET /api/stats', () => {
    it('should return statistics', async () => {
      const req = new Request('http://localhost/api/stats')

      const db = mockEnv.finn_db
      ;(db.prepare as any).mockReturnValue({
        first: vi.fn()
          .mockResolvedValueOnce({ count: 42 }) // packages
          .mockResolvedValueOnce({ count: 10 }) // users
          .mockResolvedValueOnce({ total: 5000 }), // downloads
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(200)
      expect(json).toEqual({
        packages: 42,
        users: 10,
        downloads: 5000,
      })
    })

    it('should handle database errors gracefully', async () => {
      const req = new Request('http://localhost/api/stats')

      const db = mockEnv.finn_db
      ;(db.prepare as any).mockReturnValue({
        first: vi.fn().mockRejectedValue(new Error('DB error')),
      })

      const res = await app.fetch(req, mockEnv as any)
      const json = await res.json()

      expect(res.status).toBe(200)
      expect(json).toEqual({
        packages: 0,
        users: 0,
        downloads: 0,
      })
    })
  })
})
